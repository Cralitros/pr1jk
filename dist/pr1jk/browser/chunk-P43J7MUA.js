import{a as S}from"./chunk-SO644OCK.js";import{a as D}from"./chunk-ZJDAKJRA.js";var b=class{get isDisposed(){return this._isDisposed}constructor(a,e,n,s=0,i=!1,r=!1,c=!1,o,f){this._isAlreadyOwned=!1,this._isDisposed=!1,a&&a.getScene?this._engine=a.getScene().getEngine():this._engine=a,this._updatable=n,this._instanced=r,this._divisor=o||1,this._label=f,e instanceof S?(this._data=null,this._buffer=e):(this._data=e,this._buffer=null),this.byteStride=c?s:s*Float32Array.BYTES_PER_ELEMENT,i||this.create()}createVertexBuffer(a,e,n,s,i,r=!1,c){let o=r?e:e*Float32Array.BYTES_PER_ELEMENT,f=s?r?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new I(this._engine,this,a,this._updatable,!0,f,i===void 0?this._instanced:i,o,n,void 0,void 0,!0,this._divisor||c)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(a=null){!a&&this._buffer||(a=a||this._data,a&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,a),this._data=a):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(a,this._label),this._data=a):this._buffer=this._engine.createVertexBuffer(a,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}D.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(a){this.create(a)}updateDirectly(a,e,n,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,a,s?e:e*Float32Array.BYTES_PER_ELEMENT,n?n*this.byteStride:void 0),e===0&&n===void 0?this._data=a:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}},I=(()=>{class t{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){let n=e!=0;this._instanceDivisor=e,n!==this._instanced&&(this._instanced=n,this._computeHashCode())}get _maxVerticesCount(){let e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,n,s,i,r,c,o,f,d,u,h=!1,l=!1,_=1,g=!1){this._isDisposed=!1;let E=!1;if(this.engine=e,typeof i=="object"&&i!==null?(E=i.updatable??!1,r=i.postponeInternalCreation,c=i.stride,o=i.instanced,f=i.offset,d=i.size,u=i.type,h=i.normalized??!1,l=i.useBytes??!1,_=i.divisor??1,g=i.takeBufferOwnership??!1,this._label=i.label):E=!!i,n instanceof b?(this._buffer=n,this._ownsBuffer=g):(this._buffer=new b(e,n,E,c,r,o,l,_,this._label),this._ownsBuffer=!0),this.uniqueId=t._Counter++,this._kind=s,u===void 0){let T=this.getData();this.type=T?t.GetDataType(T):t.FLOAT}else this.type=u;let y=t.GetTypeByteLength(this.type);l?(this._size=d||(c?c/y:t.DeduceStride(s)),this.byteStride=c||this._buffer.byteStride||this._size*y,this.byteOffset=f||0):(this._size=d||c||t.DeduceStride(s),this.byteStride=c?c*y:this._buffer.byteStride||this._size*y,this.byteOffset=(f||0)*y),this.normalized=h,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?_:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,n){let s=this.getData();return s?t.GetFloatData(s,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,n):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/t.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/t.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*t.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,n,s=!1){this._buffer.updateDirectly(e,n,void 0,s),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,n){t.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,n)}_alignBuffer(){}static DeduceStride(e){switch(e){case t.UVKind:case t.UV2Kind:case t.UV3Kind:case t.UV4Kind:case t.UV5Kind:case t.UV6Kind:return 2;case t.NormalKind:case t.PositionKind:return 3;case t.ColorKind:case t.ColorInstanceKind:case t.MatricesIndicesKind:case t.MatricesIndicesExtraKind:case t.MatricesWeightsKind:case t.MatricesWeightsExtraKind:case t.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?t.BYTE:e instanceof Uint8Array?t.UNSIGNED_BYTE:e instanceof Int16Array?t.SHORT:e instanceof Uint16Array?t.UNSIGNED_SHORT:e instanceof Int32Array?t.INT:e instanceof Uint32Array?t.UNSIGNED_INT:t.FLOAT}static GetTypeByteLength(e){switch(e){case t.BYTE:case t.UNSIGNED_BYTE:return 1;case t.SHORT:case t.UNSIGNED_SHORT:return 2;case t.INT:case t.UNSIGNED_INT:case t.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,n,s,i,r,c,o,f){if(e instanceof Array){let d=n/4,u=s/4;for(let h=0;h<c;h+=i){for(let l=0;l<i;l++)f(e[d+l],h+l);d+=u}}else{let d=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),u=t.GetTypeByteLength(r);for(let h=0;h<c;h+=i){let l=n;for(let _=0;_<i;_++){let g=t._GetFloatValue(d,r,l,o);f(g,h+_),l+=u}n+=s}}}static _GetFloatValue(e,n,s,i){switch(n){case t.BYTE:{let r=e.getInt8(s);return i&&(r=Math.max(r/127,-1)),r}case t.UNSIGNED_BYTE:{let r=e.getUint8(s);return i&&(r=r/255),r}case t.SHORT:{let r=e.getInt16(s,!0);return i&&(r=Math.max(r/32767,-1)),r}case t.UNSIGNED_SHORT:{let r=e.getUint16(s,!0);return i&&(r=r/65535),r}case t.INT:return e.getInt32(s,!0);case t.UNSIGNED_INT:return e.getUint32(s,!0);case t.FLOAT:return e.getFloat32(s,!0);default:throw new Error(`Invalid component type ${n}`)}}static GetFloatData(e,n,s,i,r,c,o,f){let d=n*t.GetTypeByteLength(s),u=o*n;if(s!==t.FLOAT||r!==d){let h=new Float32Array(u);return t.ForEach(e,i,r,n,s,u,c,(l,_)=>h[_]=l),h}if(!(e instanceof Array||e instanceof Float32Array)||i!==0||e.length!==u)if(e instanceof Array){let h=i/4;return e.slice(h,h+u)}else{if(e instanceof ArrayBuffer)return new Float32Array(e,i,u);{let h=e.byteOffset+i;if(h&3&&(D.Warn("Float array must be aligned to 4-bytes border"),f=!0),f){let l=new Uint8Array(u*Float32Array.BYTES_PER_ELEMENT),_=new Uint8Array(e.buffer,h,l.length);return l.set(_),new Float32Array(l.buffer)}else return new Float32Array(e.buffer,h,u)}}return f?e.slice():e}}return t._Counter=0,t.BYTE=5120,t.UNSIGNED_BYTE=5121,t.SHORT=5122,t.UNSIGNED_SHORT=5123,t.INT=5124,t.UNSIGNED_INT=5125,t.FLOAT=5126,t.PositionKind="position",t.NormalKind="normal",t.TangentKind="tangent",t.UVKind="uv",t.UV2Kind="uv2",t.UV3Kind="uv3",t.UV4Kind="uv4",t.UV5Kind="uv5",t.UV6Kind="uv6",t.ColorKind="color",t.ColorInstanceKind="instanceColor",t.MatricesIndicesKind="matricesIndices",t.MatricesWeightsKind="matricesWeights",t.MatricesIndicesExtraKind="matricesIndicesExtra",t.MatricesWeightsExtraKind="matricesWeightsExtra",t})();export{b as a,I as b};
