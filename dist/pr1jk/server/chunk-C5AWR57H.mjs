import './polyfills.server.mjs';
import{b as Z,d as Ce,h as S}from"./chunk-7GIXXX2B.mjs";import{a as Ae,d as C,g as M,o as Oe}from"./chunk-EHNC42K2.mjs";import{b as ie,d as ne,f as Te,g as v,h as d,j as he,k as H,l as g}from"./chunk-PIIYR3FX.mjs";import{d as Y}from"./chunk-NZCZEIXJ.mjs";import{b as G}from"./chunk-ZP3WWDSP.mjs";import{a as oe,e as D}from"./chunk-KGSN7RVE.mjs";import{a as ae,b as Se}from"./chunk-JBXNSZOT.mjs";import{B as X,I as Me,J as Ie,K as me,M as K}from"./chunk-3EP7245L.mjs";import{b as T}from"./chunk-E6UFF6GL.mjs";import{a as ye}from"./chunk-QLEC6GUN.mjs";import{a as Pe,i as ge}from"./chunk-AYA2QI3U.mjs";var $=class{};$.X=new d(1,0,0);$.Y=new d(0,1,0);$.Z=new d(0,0,1);var ve=class o{static GetPlanes(e){let t=[];for(let s=0;s<6;s++)t.push(new Ce(0,0,0,0));return o.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){let s=e.m;t.normal.x=s[3]+s[2],t.normal.y=s[7]+s[6],t.normal.z=s[11]+s[10],t.d=s[15]+s[14],t.normalize()}static GetFarPlaneToRef(e,t){let s=e.m;t.normal.x=s[3]-s[2],t.normal.y=s[7]-s[6],t.normal.z=s[11]-s[10],t.d=s[15]-s[14],t.normalize()}static GetLeftPlaneToRef(e,t){let s=e.m;t.normal.x=s[3]+s[0],t.normal.y=s[7]+s[4],t.normal.z=s[11]+s[8],t.d=s[15]+s[12],t.normalize()}static GetRightPlaneToRef(e,t){let s=e.m;t.normal.x=s[3]-s[0],t.normal.y=s[7]-s[4],t.normal.z=s[11]-s[8],t.d=s[15]-s[12],t.normalize()}static GetTopPlaneToRef(e,t){let s=e.m;t.normal.x=s[3]-s[1],t.normal.y=s[7]-s[5],t.normal.z=s[11]-s[9],t.d=s[15]-s[13],t.normalize()}static GetBottomPlaneToRef(e,t){let s=e.m;t.normal.x=s[3]+s[1],t.normal.y=s[7]+s[5],t.normal.z=s[11]+s[9],t.d=s[15]+s[13],t.normalize()}static GetPlanesToRef(e,t){o.GetNearPlaneToRef(e,t[0]),o.GetFarPlaneToRef(e,t[1]),o.GetLeftPlaneToRef(e,t[2]),o.GetRightPlaneToRef(e,t[3]),o.GetTopPlaneToRef(e,t[4]),o.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let s=0;s<6;s++)if(t[s].dotCoordinate(e)<0)return!1;return!0}};var U=class o{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){let s=t.subtract(e),r=Math.atan2(s.y,s.x);return new o(r)}static BetweenTwoVectors(e,t){let s=e.lengthSquared()*t.lengthSquared();if(s===0)return new o(Math.PI/2);s=Math.sqrt(s);let r=e.dot(t)/s;r=D(r,-1,1);let i=Math.acos(r);return new o(i)}static FromRadians(e){return new o(e)}static FromDegrees(e){return new o(e*Math.PI/180)}},Re=class{constructor(e,t,s){this.startPoint=e,this.midPoint=t,this.endPoint=s;let r=Math.pow(t.x,2)+Math.pow(t.y,2),i=(Math.pow(e.x,2)+Math.pow(e.y,2)-r)/2,n=(r-Math.pow(s.x,2)-Math.pow(s.y,2))/2,h=(e.x-t.x)*(t.y-s.y)-(t.x-s.x)*(e.y-t.y);this.centerPoint=new v((i*(t.y-s.y)-n*(e.y-t.y))/h,((e.x-t.x)*n-(t.x-s.x)*i)/h),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=U.BetweenTwoPoints(this.centerPoint,this.startPoint);let a=this.startAngle.degrees(),c=U.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),l=U.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-a>180&&(c-=360),c-a<-180&&(c+=360),l-c>180&&(l-=360),l-c<-180&&(l+=360),this.orientation=c-a<0?0:1,this.angle=U.FromDegrees(this.orientation===0?a-l:l-a)}},we=class o{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new v(e,t))}addLineTo(e,t){if(this.closed)return this;let s=new v(e,t),r=this._points[this._points.length-1];return this._points.push(s),this._length+=s.subtract(r).length(),this}addArcTo(e,t,s,r,i=36){if(this.closed)return this;let n=this._points[this._points.length-1],h=new v(e,t),a=new v(s,r),c=new Re(n,h,a),l=c.angle.radians()/i;c.orientation===0&&(l*=-1);let u=c.startAngle.radians()+l;for(let f=0;f<i;f++){let p=Math.cos(u)*c.radius+c.centerPoint.x,b=Math.sin(u)*c.radius+c.centerPoint.y;this.addLineTo(p,b),u+=l}return this}addQuadraticCurveTo(e,t,s,r,i=36){if(this.closed)return this;let n=(a,c,l,u)=>(1-a)*(1-a)*c+2*a*(1-a)*l+a*a*u,h=this._points[this._points.length-1];for(let a=0;a<=i;a++){let c=a/i,l=n(c,h.x,e,s),u=n(c,h.y,t,r);this.addLineTo(l,u)}return this}addBezierCurveTo(e,t,s,r,i,n,h=36){if(this.closed)return this;let a=(l,u,f,p,b)=>(1-l)*(1-l)*(1-l)*u+3*l*(1-l)*(1-l)*f+3*l*l*(1-l)*p+l*l*l*b,c=this._points[this._points.length-1];for(let l=0;l<=h;l++){let u=l/h,f=a(u,c.x,e,s,i),p=a(u,c.y,t,r,n);this.addLineTo(f,p)}return this}isPointInside(e){let t=!1,s=this._points.length;for(let r=s-1,i=0;i<s;r=i++){let n=this._points[r],h=this._points[i],a=h.x-n.x,c=h.y-n.y;if(Math.abs(c)>Number.EPSILON){if(c<0&&(n=this._points[i],a=-a,h=this._points[r],c=-c),e.y<n.y||e.y>h.y)continue;if(e.y===n.y&&e.x===n.x)return!0;{let l=c*(e.x-n.x)-a*(e.y-n.y);if(l===0)return!0;if(l<0)continue;t=!t}}else{if(e.y!==n.y)continue;if(h.x<=e.x&&e.x<=n.x||n.x<=e.x&&e.x<=h.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){let t=this._points[this._points.length-1],s=this._points[0];e+=s.subtract(t).length()}return e}area(){let e=this._points.length,t=0;for(let s=e-1,r=0;r<e;s=r++)t+=this._points[s].x*this._points[r].y-this._points[r].x*this._points[s].y;return t*.5}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return v.Zero();let t=e*this.length(),s=0;for(let r=0;r<this._points.length;r++){let i=(r+1)%this._points.length,n=this._points[r],a=this._points[i].subtract(n),c=a.length()+s;if(t>=s&&t<=c){let l=a.normalize(),u=t-s;return new v(n.x+l.x*u,n.y+l.y*u)}s=c}return v.Zero()}static StartingAt(e,t){return new o(e,t)}},Ee=class o{constructor(e,t=null,s,r=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:d.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:H.Identity()};for(let i=0;i<e.length;i++)this._curve[i]=e[i].clone();this._raw=s||!1,this._alignTangentsWithPath=r,this._compute(t,r)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?d.TransformCoordinates(d.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?d.TransformCoordinates(d.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?d.TransformCoordinates(d.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,s=0;for(let r=0;r<this._curve.length-1;r++){let i=this._curve[r+0],n=this._curve[r+1].subtract(i).normalize(),h=this._distances[r+1]-this._distances[r+0],a=Math.min(Math.max(d.Dot(n,e.subtract(i).normalize()),0)*d.Distance(i,e)/h,1),c=d.Distance(i.add(n.scale(a*h)),e);c<t&&(t=c,s=(this._distances[r+0]+h*a)/this.length())}return s}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){let c=e;e=t,t=c}let s=this.getCurve(),r=this.getPointAt(e),i=this.getPreviousPointIndexAt(e),n=this.getPointAt(t),h=this.getPreviousPointIndexAt(t)+1,a=[];return e!==0&&(i++,a.push(r)),a.push(...s.slice(i,h)),(t!==1||e===1)&&a.push(n),new o(a,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,s=!1){for(let r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t,s),this}_compute(e,t=!1){let s=this._curve.length;if(s<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[s-1]=this._curve[s-1].subtract(this._curve[s-2]),this._raw||this._tangents[s-1].normalize();let r=this._tangents[0],i=this._normalVector(r,e);this._normals[0]=i,this._raw||this._normals[0].normalize(),this._binormals[0]=d.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let n,h,a,c,l;for(let u=1;u<s;u++)n=this._getLastNonNullVector(u),u<s-1&&(h=this._getFirstNonNullVector(u),this._tangents[u]=t?h:n.add(h),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+this._curve[u].subtract(this._curve[u-1]).length(),a=this._tangents[u],l=this._binormals[u-1],this._normals[u]=d.Cross(l,a),this._raw||(this._normals[u].length()===0?(c=this._normals[u-1],this._normals[u]=c.clone()):this._normals[u].normalize()),this._binormals[u]=d.Cross(a,this._normals[u]),this._raw||this._binormals[u].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,s=this._curve[e+t].subtract(this._curve[e]);for(;s.length()===0&&e+t+1<this._curve.length;)t++,s=this._curve[e+t].subtract(this._curve[e]);return s}_getLastNonNullVector(e){let t=1,s=this._curve[e].subtract(this._curve[e-t]);for(;s.length()===0&&e>t+1;)t++,s=this._curve[e].subtract(this._curve[e-t]);return s}_normalVector(e,t){let s,r=e.length();if(r===0&&(r=1),t==null){let i;oe(Math.abs(e.y)/r,1,ne)?oe(Math.abs(e.x)/r,1,ne)?oe(Math.abs(e.z)/r,1,ne)?i=d.Zero():i=new d(0,0,1):i=new d(1,0,0):i=new d(0,-1,0),s=d.Cross(e,i)}else s=d.Cross(e,t),d.CrossToRef(s,e,s);return s.normalize(),s}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;let s=this.getPoints();if(e<=0)return this._setPointAtData(0,0,s[0],0,t);if(e>=1)return this._setPointAtData(1,1,s[s.length-1],s.length-1,t);let r=s[0],i,n=0,h=e*this.length();for(let a=1;a<s.length;a++){i=s[a];let c=d.Distance(r,i);if(n+=c,n===h)return this._setPointAtData(e,1,i,a,t);if(n>h){let u=(n-h)/c,f=r.subtract(i),p=i.add(f.scaleInPlace(u));return this._setPointAtData(e,1-u,p,a-1,t)}r=i}return this._pointAtData}_setPointAtData(e,t,s,r,i){return this._pointAtData.point=s,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=r,this._pointAtData.interpolateReady=i,i&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=H.Identity();let e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){let t=e+1,s=this._tangents[e].clone(),r=this._normals[e].clone(),i=this._binormals[e].clone(),n=this._tangents[t].clone(),h=this._normals[t].clone(),a=this._binormals[t].clone(),c=he.RotationQuaternionFromAxis(r,i,s),l=he.RotationQuaternionFromAxis(h,a,n);he.Slerp(c,l,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}},Fe=class o{static CreateQuadraticBezier(e,t,s,r){r=r>2?r:3;let i=[],n=(h,a,c,l)=>(1-h)*(1-h)*a+2*h*(1-h)*c+h*h*l;for(let h=0;h<=r;h++)i.push(new d(n(h/r,e.x,t.x,s.x),n(h/r,e.y,t.y,s.y),n(h/r,e.z,t.z,s.z)));return new o(i)}static CreateCubicBezier(e,t,s,r,i){i=i>3?i:4;let n=[],h=(a,c,l,u,f)=>(1-a)*(1-a)*(1-a)*c+3*a*(1-a)*(1-a)*l+3*a*a*(1-a)*u+a*a*a*f;for(let a=0;a<=i;a++)n.push(new d(h(a/i,e.x,t.x,s.x,r.x),h(a/i,e.y,t.y,s.y,r.y),h(a/i,e.z,t.z,s.z,r.z)));return new o(n)}static CreateHermiteSpline(e,t,s,r,i){let n=[],h=1/i;for(let a=0;a<=i;a++)n.push(d.Hermite(e,t,s,r,a*h));return new o(n)}static CreateCatmullRomSpline(e,t,s){let r=[],i=1/t,n=0;if(s){let h=e.length;for(let a=0;a<h;a++){n=0;for(let c=0;c<t;c++)r.push(d.CatmullRom(e[a%h],e[(a+1)%h],e[(a+2)%h],e[(a+3)%h],n)),n+=i}r.push(r[0])}else{let h=[];h.push(e[0].clone()),Array.prototype.push.apply(h,e),h.push(e[e.length-1].clone());let a=0;for(;a<h.length-3;a++){n=0;for(let c=0;c<t;c++)r.push(d.CatmullRom(h[a],h[a+1],h[a+2],h[a+3],n)),n+=i}a--,r.push(d.CatmullRom(h[a],h[a+1],h[a+2],h[a+3],n))}return new o(r)}static ArcThru3Points(e,t,s,r=32,i=!1,n=!1){let h=[],a=t.subtract(e),c=s.subtract(t),l=e.subtract(s),u=d.Cross(a,c),f=u.length();if(f<Math.pow(10,-8))return new o(h);let p=a.lengthSquared(),b=c.lengthSquared(),y=l.lengthSquared(),x=u.lengthSquared(),I=a.length(),A=c.length(),O=l.length(),P=.5*I*A*O/f,m=d.Dot(a,l),_=d.Dot(a,c),w=d.Dot(c,l),E=-.5*b*m/x,j=-.5*y*_/x,fe=-.5*p*w/x,q=e.scale(E).add(t.scale(j)).add(s.scale(fe)),pe=e.subtract(q).normalize(),xe=d.Cross(u,pe).normalize();if(n){let re=2*Math.PI/r;for(let V=0;V<=2*Math.PI;V+=re)h.push(q.add(pe.scale(P*Math.cos(V)).add(xe.scale(P*Math.sin(V)))));h.push(e)}else{let re=1/r,V=0,_e=d.Zero();do _e=q.add(pe.scale(P*Math.cos(V)).add(xe.scale(P*Math.sin(V)))),h.push(_e),V+=re;while(!_e.equalsWithEpsilon(s,P*re*1.1));h.push(s),i&&h.push(e)}return new o(h)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){let t=this._points[this._points.length-1],s=this._points.slice(),r=e.getPoints();for(let n=1;n<r.length;n++)s.push(r[n].subtract(r[0]).add(t));return new o(s)}_computeLength(e){let t=0;for(let s=1;s<e.length;s++)t+=e[s].subtract(e[s-1]).length();return t}};var L=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],ze=[()=>1,o=>o.y,o=>o.z,o=>o.x,o=>o.x*o.y,o=>o.y*o.z,o=>3*o.z*o.z-1,o=>o.x*o.z,o=>o.x*o.x-o.y*o.y],z=(o,e)=>L[o]*ze[o](e),B=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],Q=class o{constructor(){this.preScaled=!1,this.l00=d.Zero(),this.l1_1=d.Zero(),this.l10=d.Zero(),this.l11=d.Zero(),this.l2_2=d.Zero(),this.l2_1=d.Zero(),this.l20=d.Zero(),this.l21=d.Zero(),this.l22=d.Zero()}addLight(e,t,s){g.Vector3[0].set(t.r,t.g,t.b);let r=g.Vector3[0],i=g.Vector3[1];r.scaleToRef(s,i),i.scaleToRef(z(0,e),g.Vector3[2]),this.l00.addInPlace(g.Vector3[2]),i.scaleToRef(z(1,e),g.Vector3[2]),this.l1_1.addInPlace(g.Vector3[2]),i.scaleToRef(z(2,e),g.Vector3[2]),this.l10.addInPlace(g.Vector3[2]),i.scaleToRef(z(3,e),g.Vector3[2]),this.l11.addInPlace(g.Vector3[2]),i.scaleToRef(z(4,e),g.Vector3[2]),this.l2_2.addInPlace(g.Vector3[2]),i.scaleToRef(z(5,e),g.Vector3[2]),this.l2_1.addInPlace(g.Vector3[2]),i.scaleToRef(z(6,e),g.Vector3[2]),this.l20.addInPlace(g.Vector3[2]),i.scaleToRef(z(7,e),g.Vector3[2]),this.l21.addInPlace(g.Vector3[2]),i.scaleToRef(z(8,e),g.Vector3[2]),this.l22.addInPlace(g.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(B[0]),this.l1_1.scaleInPlace(B[1]),this.l10.scaleInPlace(B[2]),this.l11.scaleInPlace(B[3]),this.l2_2.scaleInPlace(B[4]),this.l2_1.scaleInPlace(B[5]),this.l20.scaleInPlace(B[6]),this.l21.scaleInPlace(B[7]),this.l22.scaleInPlace(B[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(L[0]),this.l1_1.scaleInPlace(L[1]),this.l10.scaleInPlace(L[2]),this.l11.scaleInPlace(L[3]),this.l2_2.scaleInPlace(L[4]),this.l2_1.scaleInPlace(L[5]),this.l20.scaleInPlace(L[6]),this.l21.scaleInPlace(L[7]),this.l22.scaleInPlace(L[8])}updateFromArray(e){return d.FromArrayToRef(e[0],0,this.l00),d.FromArrayToRef(e[1],0,this.l1_1),d.FromArrayToRef(e[2],0,this.l10),d.FromArrayToRef(e[3],0,this.l11),d.FromArrayToRef(e[4],0,this.l2_2),d.FromArrayToRef(e[5],0,this.l2_1),d.FromArrayToRef(e[6],0,this.l20),d.FromArrayToRef(e[7],0,this.l21),d.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return d.FromFloatsToRef(e[0],e[1],e[2],this.l00),d.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),d.FromFloatsToRef(e[6],e[7],e[8],this.l10),d.FromFloatsToRef(e[9],e[10],e[11],this.l11),d.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),d.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),d.FromFloatsToRef(e[18],e[19],e[20],this.l20),d.FromFloatsToRef(e[21],e[22],e[23],this.l21),d.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new o().updateFromArray(e)}static FromPolynomial(e){let t=new o;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}},le=class o{constructor(){this.x=d.Zero(),this.y=d.Zero(),this.z=d.Zero(),this.xx=d.Zero(),this.yy=d.Zero(),this.zz=d.Zero(),this.xy=d.Zero(),this.yz=d.Zero(),this.zx=d.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Q.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){g.Vector3[0].copyFromFloats(e.r,e.g,e.b);let t=g.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),g.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),g.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(g.Vector3[0]).addInPlace(g.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(g.Vector3[0]).subtractInPlace(g.Vector3[1]),this.zz.copyFrom(e.l00),g.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(g.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new o().updateFromHarmonics(e)}static FromArray(e){let t=new o;return d.FromArrayToRef(e[0],0,t.x),d.FromArrayToRef(e[1],0,t.y),d.FromArrayToRef(e[2],0,t.z),d.FromArrayToRef(e[3],0,t.xx),d.FromArrayToRef(e[4],0,t.yy),d.FromArrayToRef(e[5],0,t.zz),d.FromArrayToRef(e[6],0,t.yz),d.FromArrayToRef(e[7],0,t.zx),d.FromArrayToRef(e[8],0,t.xy),t}};var W=class{constructor(e,t,s,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=s,this.worldAxisForFileY=r}},J=class{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();let t=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1),i,n;e.isRenderTarget?(i=e.readPixels(3,void 0,void 0,!1),n=e.readPixels(2,void 0,void 0,!1)):(i=e.readPixels(2,void 0,void 0,!1),n=e.readPixels(3,void 0,void 0,!1));let h=e.readPixels(4,void 0,void 0,!1),a=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,l=5,u=0;return(e.textureType==1||e.textureType==2)&&(u=1),new Promise(f=>{Promise.all([r,s,i,n,h,a]).then(([p,b,y,x,I,A])=>{let O={size:t,right:b,left:p,up:y,down:x,front:I,back:A,format:l,type:u,gammaSpace:c};f(this.ConvertCubeMapToSphericalPolynomial(O))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){let t=new Q,s=0,r=2/e.size,i=r,n=.5*r,h=n-1;for(let f=0;f<6;f++){let p=this._FileFaces[f],b=e[p.name],y=h,x=e.format===5?4:3;for(let I=0;I<e.size;I++){let A=h;for(let O=0;O<e.size;O++){let P=p.worldAxisForFileX.scale(A).add(p.worldAxisForFileY.scale(y)).add(p.worldAxisForNormal);P.normalize();let m=this._AreaElement(A-n,y-n)-this._AreaElement(A-n,y+n)-this._AreaElement(A+n,y-n)+this._AreaElement(A+n,y+n),_=b[I*e.size*x+O*x+0],w=b[I*e.size*x+O*x+1],E=b[I*e.size*x+O*x+2];isNaN(_)&&(_=0),isNaN(w)&&(w=0),isNaN(E)&&(E=0),e.type===0&&(_/=255,w/=255,E/=255),e.gammaSpace&&(_=Math.pow(D(_),ie),w=Math.pow(D(w),ie),E=Math.pow(D(E),ie));let j=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){let q=Math.max(_,w,E);if(q>j){let se=j/q;_*=se,w*=se,E*=se}}else _=D(_,0,j),w=D(w,0,j),E=D(E,0,j);let fe=new Ae(_,w,E);t.addLight(P,fe,m),s+=m,A+=r}y+=i}}let u=4*Math.PI*6/6/s;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),le.FromHarmonics(t)}};J._FileFaces=[new W("right",new d(1,0,0),new d(0,0,-1),new d(0,-1,0)),new W("left",new d(-1,0,0),new d(0,0,1),new d(0,-1,0)),new W("up",new d(0,1,0),new d(1,0,0),new d(0,0,1)),new W("down",new d(0,-1,0),new d(1,0,0),new d(0,0,-1)),new W("front",new d(0,0,1),new d(1,0,0),new d(0,-1,0)),new W("back",new d(0,0,-1),new d(-1,0,0),new d(0,-1,0))];J.MAX_HDRI_VALUE=4096;J.PRESERVE_CLAMPED_COLORS=!1;var ce=class{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new T,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[G.PositionKind])return;let e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[G.PositionKind]=new G(this._scene.getEngine(),e,G.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){let e=this._vertexBuffers[G.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){let s=this._scene.activeCamera;return!s||(t=t||s._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(s,e,t!=null),!0)}directRender(e,t=null,s=!1,r=0,i=0,n=!1){let h=this._scene.getEngine();for(let a=0;a<e.length;a++){a<e.length-1?e[a+1].activate(this._scene.activeCamera,t?.texture):(t?h.bindFramebuffer(t,r,void 0,void 0,s,i):n||h.restoreDefaultFramebuffer(),h._debugInsertMarker?.(`post process ${e[a].name} output`));let c=e[a],l=c.apply();l&&(c.onBeforeRenderObservable.notifyObservers(l),this._prepareBuffers(),h.bindBuffers(this._vertexBuffers,this._indexBuffer,l),h.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(l))}h.setDepthBuffer(!0),h.setDepthWrite(!0)}_finalizeFrame(e,t,s,r,i=!1){let n=this._scene.activeCamera;if(!n||(this.onBeforeRenderObservable.notifyObservers(this),r=r||n._postProcesses.filter(a=>a!=null),r.length===0||!this._scene.postProcessesEnabled))return;let h=this._scene.getEngine();for(let a=0,c=r.length;a<c;a++){let l=r[a];if(a<c-1?l._outputTexture=r[a+1].activate(n,t?.texture):(t?(h.bindFramebuffer(t,s,void 0,void 0,i),l._outputTexture=t):(h.restoreDefaultFramebuffer(),l._outputTexture=null),h._debugInsertMarker?.(`post process ${r[a].name} output`)),e)break;let u=l.apply();u&&(l.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),h.bindBuffers(this._vertexBuffers,this._indexBuffer,u),h.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(u))}h.setDepthBuffer(!0),h.setDepthWrite(!0),h.setAlphaMode(0)}dispose(){let e=this._vertexBuffers[G.PositionKind];e&&(e.dispose(),this._vertexBuffers[G.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}};var F=(()=>{class o{constructor(t){this.length=0,this.data=new Array(t),this._id=o._GlobalId++}push(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2)}forEach(t){for(let s=0;s<this.length;s++)t(this.data[s])}sort(t){this.data.sort(t)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(t){if(t.length!==0){this.length+t.length>this.data.length&&(this.data.length=(this.length+t.length)*2);for(let s=0;s<t.length;s++)this.data[this.length++]=(t.data||t)[s]}}indexOf(t){let s=this.data.indexOf(t);return s>=this.length?-1:s}contains(t){return this.indexOf(t)!==-1}}return o._GlobalId=0,o})(),de=class extends F{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){let s=(e.data||e)[t];this.pushNoDuplicate(s)}}}};var ee=class o{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=o.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=o.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=o.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,s=null,r=null,i=null){this.index=e,this._opaqueSubMeshes=new F(256),this._transparentSubMeshes=new F(256),this._alphaTestSubMeshes=new F(256),this._depthOnlySubMeshes=new F(256),this._particleSystems=new F(256),this._spriteManagers=new F(256),this._empty=!0,this._edgesRenderers=new de(16),this._scene=t,this.opaqueSortCompareFn=s,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=i}render(e,t,s,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let i=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(i.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),i.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let n=i.getStencilBuffer();if(i.setStencilBuffer(!1),t&&this._renderSprites(),s&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(i.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){let h=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);h.length&&this._renderTransparent(h)}else this._renderTransparent(this._transparentSubMeshes);i.setAlphaMode(0)}if(i.setStencilBuffer(!1),this._edgesRenderers.length){for(let h=0;h<this._edgesRenderers.length;h++)this._edgesRenderers.data[h].render();i.setAlphaMode(0)}i.setStencilBuffer(n)}_renderOpaqueSorted(e){o._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){o._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){o._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,s,r){let i=0,n,h=s?s.globalPosition:o._ZeroVector;if(r)for(;i<e.length;i++)n=e.data[i],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=d.Distance(n.getBoundingInfo().boundingSphere.centerWorld,h);let a=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&a.sort(t);let c=a[0].getMesh().getScene();for(i=0;i<a.length;i++)if(n=a[i],!(c._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(c._frustumPlanes))){if(r){let l=n.getMaterial();if(l&&l.needDepthPrePass){let u=l.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),n.render(!1),u.setColorWrite(!0)}}n.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:o.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){let s=e.getMesh(),r=t.getMesh();return s.material&&r.material?s.material.uniqueId-r.material.uniqueId:s.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,s){t===void 0&&(t=e.getMesh()),s===void 0&&(s=e.getMaterial()),s!=null&&(s.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):s.needAlphaTesting()?(s.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(s.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;let t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let s=0;s<this._particleSystems.length;s++){let r=this._particleSystems.data[s];if((t&&t.layerMask&r.layerMask)===0)continue;let i=r.emitter;(!i.position||!e||e.indexOf(i)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){let s=this._spriteManagers.data[t];(e&&e.layerMask&s.layerMask)!==0&&s.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};ee._ZeroVector=d.Zero();var be=class{},Le=(()=>{class o{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(t){t!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=t,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(let t of this._scene.meshes)if(t.subMeshes)for(let s of t.subMeshes)s._wasDispatched=!1;if(this._scene.spriteManagers)for(let t of this._scene.spriteManagers)t._wasDispatched=!1;for(let t of this._scene.particleSystems)t._wasDispatched=!1}constructor(t){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new be,this._maintainStateBetweenFrames=!1,this._scene=t;for(let s=o.MIN_RENDERINGGROUPS;s<o.MAX_RENDERINGGROUPS;s++)this._autoClearDepthStencil[s]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(t){let s=t||0;return this._prepareRenderingGroup(s),this._renderingGroups[s]}_clearDepthStencilBuffer(t=!0,s=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,t,s),this._depthStencilBufferAlreadyCleaned=!0)}render(t,s,r,i){let n=this._renderingGroupInfo;if(n.scene=this._scene,n.camera=this._scene.activeCamera,this._scene.spriteManagers&&i)for(let h=0;h<this._scene.spriteManagers.length;h++){let a=this._scene.spriteManagers[h];this.dispatchSprites(a)}for(let h=o.MIN_RENDERINGGROUPS;h<o.MAX_RENDERINGGROUPS;h++){this._depthStencilBufferAlreadyCleaned=h===o.MIN_RENDERINGGROUPS;let a=this._renderingGroups[h];if(!a||a._empty)continue;let c=1<<h;if(n.renderingGroupId=h,this._scene.onBeforeRenderingGroupObservable.notifyObservers(n,c),o.AUTOCLEAR){let l=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(h):this._autoClearDepthStencil[h];l&&l.autoClear&&this._clearDepthStencilBuffer(l.depth,l.stencil)}for(let l of this._scene._beforeRenderingGroupDrawStage)l.action(h);a.render(t,i,r,s);for(let l of this._scene._afterRenderingGroupDrawStage)l.action(h);this._scene.onAfterRenderingGroupObservable.notifyObservers(n,c)}}reset(){if(!this.maintainStateBetweenFrames)for(let t=o.MIN_RENDERINGGROUPS;t<o.MAX_RENDERINGGROUPS;t++){let s=this._renderingGroups[t];s&&s.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let t=o.MIN_RENDERINGGROUPS;t<o.MAX_RENDERINGGROUPS;t++){let s=this._renderingGroups[t];s&&s.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let t=o.MIN_RENDERINGGROUPS;t<o.MAX_RENDERINGGROUPS;t++){let s=this._renderingGroups[t];s&&s.dispose()}}_prepareRenderingGroup(t){this._renderingGroups[t]===void 0&&(this._renderingGroups[t]=new ee(t,this._scene,this._customOpaqueSortCompareFn[t],this._customAlphaTestSortCompareFn[t],this._customTransparentSortCompareFn[t]))}dispatchSprites(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchSprites(t))}dispatchParticles(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchParticles(t))}dispatch(t,s,r){s===void 0&&(s=t.getMesh()),!(this.maintainStateBetweenFrames&&t._wasDispatched)&&(t._wasDispatched=!0,this.getRenderingGroup(s.renderingGroupId).dispatch(t,s,r))}setRenderingOrder(t,s=null,r=null,i=null){if(this._customOpaqueSortCompareFn[t]=s,this._customAlphaTestSortCompareFn[t]=r,this._customTransparentSortCompareFn[t]=i,this._renderingGroups[t]){let n=this._renderingGroups[t];n.opaqueSortCompareFn=this._customOpaqueSortCompareFn[t],n.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[t],n.transparentSortCompareFn=this._customTransparentSortCompareFn[t]}}setRenderingAutoClearDepthStencil(t,s,r=!0,i=!0){this._autoClearDepthStencil[t]={autoClear:s,depth:r,stencil:i}}getAutoClearDepthStencilSetup(t){return this._autoClearDepthStencil[t]}}return o.MAX_RENDERINGGROUPS=4,o.MIN_RENDERINGGROUPS=0,o.AUTOCLEAR=!0,o})();var te=(()=>{class o{get renderList(){return this._renderList}set renderList(t){this._renderList!==t&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),t&&(this._unObserveRenderList=Te(t,this._renderListHasChanged)),this._renderList=t)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(t,s){let r;Array.isArray(t)?r=t:r=[t];for(let i=0;i<r.length;++i)for(let n=0;n<this.options.numPasses;++n)r[i].setMaterialForRenderPass(this._renderPassIds[n],s!==void 0?Array.isArray(s)?s[n]:s:void 0)}constructor(t,s,r){this._unObserveRenderList=null,this._renderListHasChanged=(i,n)=>{let h=this._renderList?this._renderList.length:0;(n===0&&h>0||h===0)&&this._scene.meshes.forEach(a=>{a._markSubMeshesAsLightDirty()})},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.onBeforeRenderObservable=new T,this.onAfterRenderObservable=new T,this.onBeforeRenderingManagerRenderObservable=new T,this.onAfterRenderingManagerRenderObservable=new T,this.onFastPathRenderObservable=new T,this._currentRefreshId=-1,this._refreshRate=1,this._currentSceneCamera=null,this.name=t,this._scene=s,this.renderList=[],this._renderPassIds=[],this.options=Pe({numPasses:1,doNotChangeAspectRatio:!0},r),this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new Le(s),this._renderingManager._useSceneAutoClearSetup=!0}_releaseRenderPassId(){let t=this._scene.getEngine();for(let s=0;s<this.options.numPasses;++s)t.releaseRenderPassId(this._renderPassIds[s]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();let t=this._scene.getEngine();for(let s=0;s<this.options.numPasses;++s)this._renderPassIds[s]=t.createRenderPassId(`ObjectRenderer - ${this.name}#${s}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(t){this._refreshRate=t,this.resetRefreshCounter()}shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(t,s){this.prepareRenderList(),this.initRender(t,s);let r=this._checkReadiness();return this.finishRender(),r}prepareRenderList(){let t=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let s=0;s<this._waitingRenderList.length;s++){let r=this._waitingRenderList[s],i=t.getMeshById(r);i&&this.renderList.push(i)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];let s=this._scene.meshes;for(let r=0;r<s.length;r++){let i=s[r];this.renderListPredicate(i)&&this.renderList.push(i)}}}initRender(t,s){let r=this._scene.getEngine(),i=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,i&&(i!==this._scene.activeCamera&&(this._scene.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(!0)),this._scene.activeCamera=i),r.setViewport(i.rigParent?i.rigParent.viewport:i.viewport,t,s)),this._defaultRenderListPrepared=!1}finishRender(){let t=this._scene;t.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==t.activeCamera&&t.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),t.getEngine().setViewport(this._currentSceneCamera.viewport)),t.resetCachedMaterial()}render(t=0,s=!1){let r=this._scene,i=r.getEngine(),n=i.currentRenderPassId;if(i.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t),i.snapshotRendering&&i.snapshotRenderingMode===1)this.onFastPathRenderObservable.notifyObservers(t);else{let a=null,c=this.renderList?this.renderList:r.getActiveMeshes().data,l=this.renderList?this.renderList.length:r.getActiveMeshes().length;this.getCustomRenderList&&(a=this.getCustomRenderList(t,c,l)),a?this._prepareRenderingManager(a,a.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(c,l,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),a=c),this.onBeforeRenderingManagerRenderObservable.notifyObservers(t),this._renderingManager.render(this.customRenderFunction,a,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(t)}s||this.onAfterRenderObservable.notifyObservers(t),i.currentRenderPassId=n}_checkReadiness(){let t=this._scene,s=t.getEngine(),r=s.currentRenderPassId,i=!0;t.getViewMatrix()||t.updateTransformMatrix();let n=this.options.numPasses;for(let a=0;a<n&&i;a++){let c=null,l=this.renderList?this.renderList:t.getActiveMeshes().data,u=this.renderList?this.renderList.length:t.getActiveMeshes().length;s.currentRenderPassId=this._renderPassIds[a],this.onBeforeRenderObservable.notifyObservers(a),this.getCustomRenderList&&(c=this.getCustomRenderList(a,l,u)),c||(c=l),this._doNotChangeAspectRatio||t.updateTransformMatrix(!0);for(let f=0;f<c.length&&i;++f){let p=c[f];if(!(!p.isEnabled()||p.isBlocked||!p.isVisible||!p.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(p,this.refreshRate,!0)){i=!1;continue}}else if(!p.isReady(!0)){i=!1;continue}}}this.onAfterRenderObservable.notifyObservers(a),n>1&&(t.incrementRenderId(),t.resetCachedMaterial())}let h=this.particleSystemList||t.particleSystems;for(let a of h)a.isReady()||(i=!1);return s.currentRenderPassId=r,i}_prepareRenderingManager(t,s,r){let i=this._scene,n=i.activeCamera;this._renderingManager.reset();let h=i.getRenderId();for(let c=0;c<s;c++){let l=t[c];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&n&&(l._internalAbstractMeshDataInfo._currentLOD=i.customLODSelector?i.customLODSelector(l,n):l.getLOD(n),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;let u=l._internalAbstractMeshDataInfo._currentLOD;u!==l&&u.billboardMode!==0&&u.computeWorldMatrix(),u._preActivateForIntermediateRendering(h);let f;if(r&&n?f=(l.layerMask&n.layerMask)===0:f=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!f){if(u!==l&&u._activate(h,!0),l._activate(h,!0)&&l.subMeshes.length){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(u=l):u._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,u._internalAbstractMeshDataInfo._isActiveIntermediate=!0,i._prepareSkeleton(u);for(let p=0;p<u.subMeshes.length;p++){let b=u.subMeshes[p];this._renderingManager.dispatch(b,u)}}l._postActivate()}}}let a=this.particleSystemList||i.particleSystems;for(let c=0;c<a.length;c++){let l=a[c],u=l.emitter;!l.isStarted()||!u||u.position&&!u.isEnabled()||this._renderingManager.dispatchParticles(l)}}setRenderingOrder(t,s=null,r=null,i=null){this._renderingManager.setRenderingOrder(t,s,r,i)}setRenderingAutoClearDepthStencil(t,s){this._renderingManager.setRenderingAutoClearDepthStencil(t,s),this._renderingManager._useSceneAutoClearSetup=!1}clone(){let t=new o(this.name,this._scene,this.options);return this.renderList&&(t.renderList=this.renderList.slice(0)),t}dispose(){this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===o.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=o.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}return o.REFRESHRATE_RENDER_ONCE=0,o.REFRESHRATE_RENDER_ONEVERYFRAME=1,o.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,o})();X.prototype.setDepthStencilTexture=function(o,e){this._engine.setDepthStencilTexture(this._samplers[o],this._uniforms[o],e,o)};var N=class o extends S{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,s,r=!1,i=!0,n=0,h=!1,a=S.TRILINEAR_SAMPLINGMODE,c=!0,l=!1,u=!1,f=5,p=!1,b,y,x=!1,I=!1){let A,O=!0;if(typeof r=="object"){let m=r;r=!!m.generateMipMaps,i=m.doNotChangeAspectRatio??!0,n=m.type??0,h=!!m.isCube,a=m.samplingMode??S.TRILINEAR_SAMPLINGMODE,c=m.generateDepthBuffer??!0,l=!!m.generateStencilBuffer,u=!!m.isMulti,f=m.format??5,p=!!m.delayAllocation,b=m.samples,y=m.creationFlags,x=!!m.noColorAttachment,I=!!m.useSRGBBuffer,A=m.colorAttachment,O=m.gammaSpace??O}if(super(null,s,!r,void 0,a,void 0,void 0,void 0,void 0,f),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new T,this.onAfterUnbindObservable=new T,this.onClearObservable=new T,this.onResizeObservable=new T,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=d.Zero(),this._dumpToolsLoading=!1,s=this.getScene(),!s)return;let P=this.getScene().getEngine();this._gammaSpace=O,this._coordinatesMode=S.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._processSizeParameter(t),this._objectRenderer=new te(e,s,{numPasses:h?6:this.getRenderLayers()||1,doNotChangeAspectRatio:i}),this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{for(let m of this._scene._beforeRenderTargetClearStage)m.action(this,this._currentFaceIndex,this._currentLayer);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(P):this.skipInitialClear||P.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0);for(let m of this._scene._beforeRenderTargetDrawStage)m.action(this,this._currentFaceIndex,this._currentLayer)}),this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{for(let _ of this._scene._afterRenderTargetDrawStage)_.action(this,this._currentFaceIndex,this._currentLayer);let m=this._texture?.generateMipMaps??!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex);for(let _ of this._scene._afterRenderTargetPostProcessStage)_.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=m),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),P):ye.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(P):this.skipInitialClear||P.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=P.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=i,!u&&(this._renderTargetOptions={generateMipMaps:r,type:n,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:l,samples:b,creationFlags:y,noColorAttachment:x,useSRGBBuffer:I,colorAttachment:A,label:this.name},this.samplingMode===S.NEAREST_SAMPLINGMODE&&(this.wrapU=S.CLAMP_ADDRESSMODE,this.wrapV=S.CLAMP_ADDRESSMODE),p||(h?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=S.INVCUBIC_MODE,this._textureMatrix=H.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,b!==void 0&&(this.samples=b)))}createDepthStencilTexture(e=0,t=!0,s=!1,r=1,i=14,n){this._renderTarget?.createDepthStencilTexture(e,t,s,r,i,n)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;let t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){let t=this.getScene();if(!t)return;this._postProcessManager=new ce(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(let t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;let t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){let e=this._size.layers;if(e)return e;let t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){let t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){let t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;let s=this.getScene();s&&(this._processSizeParameter(e),t?this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,import("./chunk-ZEK4FJQW.mjs").then(t=>this._dumpTools=t)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());let e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){let s=this.getScene();if(s){if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),(this.is2DArray||this.is3D)&&!this.isMulti)for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,e,t,r),s.incrementRenderId(),s.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,e,t),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,e,t);this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){let r=e*t,i=Me(r+128*128/(128+r));return Math.min(Ie(e),i)}_bindFrameBuffer(e=0,t=0){let s=this.getScene();if(!s)return;let r=s.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,s,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,s)}_renderToTarget(e,t,s,r=0){let i=this.getScene();if(!i)return;let n=i.getEngine();this._currentFaceIndex=e,this._currentLayer=r,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=s,this._prepareFrame(i,e,r,t),n._debugPushGroup?.(`render to face #${e} layer #${r}`,2),this._objectRenderer.render(e+r,!0),n._debugPopGroup?.(2),this._unbindFrameBuffer(n,e),this._texture&&this.isCube&&e===5&&n.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,s=null,r=null){this._objectRenderer.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){let e=this.getSize(),t=new o(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;let e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);let e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(let s of e.cameras)t=s.customRenderTargets.indexOf(this),t>=0&&s.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}};N.REFRESHRATE_RENDER_ONCE=te.REFRESHRATE_RENDER_ONCE;N.REFRESHRATE_RENDER_ONEVERYFRAME=te.REFRESHRATE_RENDER_ONEVERYFRAME;N.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=te.REFRESHRATE_RENDER_ONEVERYTWOFRAMES;S._CreateRenderTargetTexture=(o,e,t,s,r)=>new N(o,e,t,s);K.prototype.setTextureFromPostProcess=function(o,e,t){let s=null;e&&(e._forcedOutputTexture?s=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(s=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(o,s?.texture??null,t)};K.prototype.setTextureFromPostProcessOutput=function(o,e,t){this._bindTexture(o,e?._outputTexture?.texture??null,t)};X.prototype.setTextureFromPostProcess=function(o,e){this._engine.setTextureFromPostProcess(this._samplers[o],e,o)};X.prototype.setTextureFromPostProcessOutput=function(o,e){this._engine.setTextureFromPostProcessOutput(this._samplers[o],e,o)};var R=class o{static get ForceGLSL(){return Y.ForceGLSL}static set ForceGLSL(e){Y.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){Y.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,s,r,i,n,h=1,a,c,l=null,u=0,f="postprocess",p,b=!1,y=5,x,I){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new F(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new v(1,1),this._texelSize=v.Zero(),this.onActivateObservable=new T,this.onSizeChangedObservable=new T,this.onApplyObservable=new T,this.onBeforeRenderObservable=new T,this.onAfterRenderObservable=new T;let A=1,O=null,P;if(s&&!Array.isArray(s)){let _=s;s=_.uniforms??null,r=_.samplers??null,A=_.size??1,n=_.camera??null,h=_.samplingMode??1,a=_.engine,c=_.reusable,l=Array.isArray(_.defines)?_.defines.join(`
`):_.defines??null,u=_.textureType??0,f=_.vertexUrl??"postprocess",p=_.indexParameters,b=_.blockCompilation??!1,y=_.textureFormat??5,x=_.shaderLanguage??0,O=_.uniformBuffers??null,I=_.extraInitializations,P=_.effectWrapper}else i&&(typeof i=="number"?A=i:A={width:i.width,height:i.height});let m=!!P;if(this._effectWrapper=P??new Y({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:a||n?.getScene().getEngine(),uniforms:s,samplers:r,uniformBuffers:O,defines:l,vertexUrl:f,indexParameters:p,blockCompilation:!0,shaderLanguage:x,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,n!=null?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):a&&(this._engine=a,this._engine.postProcesses.push(this)),this._options=A,this.renderTargetSamplingMode=h||1,this._reusable=c||!1,this._textureType=u,this._textureFormat=y,this._shaderLanguage=x||0,this._samplers=r||[],this._samplers.indexOf("textureSampler")===-1&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=f,this._parameters=s||[],this._parameters.indexOf("scale")===-1&&this._parameters.push("scale"),this._uniformBuffers=O||[],this._indexParameters=p,!m){this._webGPUReady=this._shaderLanguage===1;let _=[];this._gatherImports(this._engine.isWebGPU&&!o.ForceGLSL,_),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(b,l,I,_)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([import("./chunk-COEDDQIF.mjs")])):t.push(Promise.all([import("./chunk-MJMYXNUZ.mjs")]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new F(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,s=null,r,i,n,h,a){this._effectWrapper.updateEffect(e,t,s,r,i,n,h,a),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join(`
`):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,s=0){for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture.width===e.width&&this._textureCache[i].texture.height===e.height&&this._textureCache[i].postProcessChannel===s&&this._textureCache[i].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[i].texture.samples===t.samples)return this._textureCache[i].texture;let r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:s,lastUsedRenderId:-1}),r}_flushTextureCache(){let e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let s=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){s=!0;break}s||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,s=null,r=!1,i=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(s){for(let c=0;c<s._postProcesses.length;c++)if(s._postProcesses[c]!==null){n=s._postProcesses[c];break}}let h={width:this.width,height:this.height},a={generateMipMaps:r,generateDepthBuffer:i||n===this,generateStencilBuffer:(i||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(h,a,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(h,a,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture===e){t=this._textureCache[s];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,s){e=e||this._camera;let r=e.getScene(),i=r.getEngine(),n=i.getCaps().maxTextureSize,h=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,a=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,c=this._options.width||h,l=this._options.height||a,u=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2,f=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){let p=i.currentViewport;p&&(c*=p.width,l*=p.height)}(u||this.alwaysForcePOT)&&(this._options.width||(c=i.needPOTTextures?me(c,n,this.scaleMode):c),this._options.height||(l=i.needPOTTextures?me(l,n,this.scaleMode):l)),(this.width!==c||this.height!==l||!(f=this._getTarget()))&&this.resize(c,l,e,u,s),this._textures.forEach(p=>{p.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(p,this.samples)}),this._flushTextureCache(),this._renderId++}return f||(f=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(h/c,a/l),this._engine.bindFramebuffer(f,0,h,a,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(f,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:r.clearColor,r._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),f}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){let s=this._parentContainer.postProcesses.indexOf(this);s>-1&&this._parentContainer.postProcesses.splice(s,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){let s=this._camera._getFirstPostProcess();s&&s.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){let e=Z.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){let e=this.serialize();e._engine=this._engine,e.cameraId=null;let t=o.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,s){let r=Se(e.customType);if(!r||!r._Parse)return null;let i=t?t.getCameraById(e.cameraId):null;return r._Parse(e,i,t,s)}static _Parse(e,t,s,r){return Z.Parse(()=>new o(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,s,r)}};C([M()],R.prototype,"uniqueId",void 0);C([M()],R.prototype,"name",null);C([M()],R.prototype,"width",void 0);C([M()],R.prototype,"height",void 0);C([M()],R.prototype,"renderTargetSamplingMode",void 0);C([Oe()],R.prototype,"clearColor",void 0);C([M()],R.prototype,"autoClear",void 0);C([M()],R.prototype,"forceAutoClearInAlphaMode",void 0);C([M()],R.prototype,"alphaMode",null);C([M()],R.prototype,"alphaConstants",void 0);C([M()],R.prototype,"enablePixelPerfectMode",void 0);C([M()],R.prototype,"forceFullscreenViewport",void 0);C([M()],R.prototype,"scaleMode",void 0);C([M()],R.prototype,"alwaysForcePOT",void 0);C([M("samples")],R.prototype,"_samples",void 0);C([M()],R.prototype,"adaptScaleToCurrentViewport",void 0);ae("BABYLON.PostProcess",R);var k=class o extends R{getClassName(){return"PassPostProcess"}constructor(e,t,s=null,r,i,n,h=0,a=!1){super(e,"pass",null,null,t,s,r,i,n,void 0,h,void 0,null,a)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([import("./chunk-RICARFHA.mjs")]))):t.push(Promise.all([import("./chunk-PDNB2UPM.mjs")])),super._gatherImports(e,t)}static _Parse(e,t,s,r){return Z.Parse(()=>new o(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,s,r)}};ae("BABYLON.PassPostProcess",k);K._RescalePostProcessFactory=o=>new k("rescale",1,null,2,o,!1,0);function Be(o,e,t,s=!0){let r=o.getScene(),i=r.getEngine(),n=new N("resized"+o.name,{width:e,height:t},r,!o.noMipmap,!0,o._texture.type,!1,o.samplingMode,!1);n.wrapU=o.wrapU,n.wrapV=o.wrapV,n.uOffset=o.uOffset,n.vOffset=o.vOffset,n.uScale=o.uScale,n.vScale=o.vScale,n.uAng=o.uAng,n.vAng=o.vAng,n.wAng=o.wAng,n.coordinatesIndex=o.coordinatesIndex,n.level=o.level,n.anisotropicFilteringLevel=o.anisotropicFilteringLevel,n._texture.isReady=!1,o.wrapU=S.CLAMP_ADDRESSMODE,o.wrapV=S.CLAMP_ADDRESSMODE;let h=new k("pass",1,null,s?S.BILINEAR_SAMPLINGMODE:S.NEAREST_SAMPLINGMODE,i,!1,0);return h.externalTextureSamplerBinding=!0,h.onEffectCreatedObservable.addOnce(a=>{a.executeWhenCompiled(()=>{h.onApply=function(l){l.setTexture("textureSampler",o)};let c=n.renderTarget;c&&(r.postProcessManager.directRender([h],c),i.unBindFramebuffer(c),n.disposeFramebufferObjects(),h.dispose(),n.getInternalTexture().isReady=!0)})}),n}function Ne(o,e,t,s,r,i,n,h){let a=e.getEngine();return e.isReady=!1,r=r??e.samplingMode,s=s??e.type,i=i??e.format,n=n??e.width,h=h??e.height,s===-1&&(s=0),new Promise(c=>{let l=new R("postprocess",o,null,null,1,null,r,a,!1,void 0,s,void 0,null,!1,i);l.externalTextureSamplerBinding=!0;let u=a.createRenderTargetTexture({width:n,height:h},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:s,format:i});l.onEffectCreatedObservable.addOnce(f=>{f.executeWhenCompiled(()=>{l.onApply=p=>{p._bindTexture("textureSampler",e),p.setFloat2("scale",1,1)},t.postProcessManager.directRender([l],u,!0),a.restoreDefaultFramebuffer(),a._releaseTexture(e),l&&l.dispose(),u._swapAndDie(e),e.type=s,e.format=5,e.isReady=!0,c(e)})})})}var ue,De;function Ve(o){ue||(ue=new Float32Array(1),De=new Int32Array(ue.buffer)),ue[0]=o;let e=De[0],t=e>>16&32768,s=e>>12&2047,r=e>>23&255;return r<103?t:r>142?(t|=31744,t|=(r==255?0:1)&&e&8388607,t):r<113?(s|=2048,t|=(s>>114-r)+(s>>113-r&1),t):(t|=r-112<<10|s>>1,t+=s&1,t)}function Ge(o){let e=(o&32768)>>15,t=(o&31744)>>10,s=o&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):t==31?s?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+s/Math.pow(2,10))}var We=(o,e,t,s,r)=>ge(void 0,null,function*(){let i=o.getScene(),n=i.getEngine();n.isWebGPU?o.isCube?yield import("./chunk-GBK7GTV6.mjs"):yield import("./chunk-DCG2DSRX.mjs"):o.isCube?yield import("./chunk-4PO436ZU.mjs"):yield import("./chunk-GSJ7OKNQ.mjs");let h;if(!o.isCube)h=new R("lod","lod",{uniforms:["lod","gamma"],samplingMode:S.NEAREST_NEAREST_MIPNEAREST,engine:n,shaderLanguage:n.isWebGPU?1:0});else{let l=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];h=new R("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:S.NEAREST_NEAREST_MIPNEAREST,engine:n,defines:l[s],shaderLanguage:n.isWebGPU?1:0})}yield new Promise(l=>{h.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{l(0)})})});let a=new N("temp",{width:e,height:t},i,!1);h.onApply=function(l){l.setTexture("textureSampler",o),l.setFloat("lod",r),l.setInt("gamma",o.gammaSpace?1:0)};let c=o.getInternalTexture();try{if(a.renderTarget&&c){let l=c.samplingMode;r!==0?o.updateSamplingMode(S.NEAREST_NEAREST_MIPNEAREST):o.updateSamplingMode(S.NEAREST_NEAREST),i.postProcessManager.directRender([h],a.renderTarget,!0),o.updateSamplingMode(l);let u=yield n.readPixels(0,0,e,t),f=new Uint8Array(u.buffer,0,u.byteLength);return n.unBindFramebuffer(a.renderTarget),f}else throw Error("Render to texture failed.")}finally{a.dispose(),h.dispose()}});function je(o,e,t,s=0,r=0){return ge(this,null,function*(){return!o.isReady()&&o._texture&&(yield new Promise((i,n)=>{if(o._texture===null){n(0);return}o._texture.onLoadedObservable.addOnce(()=>{i(0)})})),yield We(o,e,t,s,r)})}var ls={CreateResizedCopy:Be,ApplyPostProcess:Ne,ToHalfFloat:Ve,FromHalfFloat:Ge,GetTextureDataAsync:je};export{$ as a,ve as b,we as c,Ee as d,Fe as e,Q as f,le as g,J as h,ce as i,F as j,de as k,Le as l,te as m,N as n,R as o,k as p,Ne as q,Ve as r,Ge as s,ls as t};
